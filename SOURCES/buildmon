#!/usr/bin/env bash

###############################################################################

APP="RPMBuilder Node Monitor"
VER="1.1.1"

###############################################################################

BUILDER_USER="builder"
BUILDER_DIR="/home/builder"
EXEC="$BUILDER_DIR/buildmon"
BUILD_LOCK="$BUILDER_DIR/.buildlock"
CLEAN_DELAY=600
MAX_KEEP_DAYS=7 # 1 Week
DIR_LIST="BUILD BUILDROOT RPMS SOURCES SPECS SRPMS"

CWD=$(pwd)

###############################################################################

main() {
  trap doExit SIGINT SIGTERM

  check

  doExit
}

check() {
  local has_lock
  local counter=0

  while : ; do
    sleep 1

    if [[ $(pgrep -U $BUILDER_USER rpmbuild) ]] ; then
      touch $BUILD_LOCK
      has_lock=true
    else
      if [[ -n $has_lock ]] ; then
        rm -f $BUILD_LOCK
        has_lock=""
      fi
    fi

    ((counter++))

    if [[ $counter -eq $CLEAN_DELAY ]] ; then
      counter=0
      clean
    fi
  done
}

clean() {
  for dir in $DIR_LIST ; do
    find "$BUILDER_DIR/rpmbuild/$dir" -maxdepth 1 -mtime +$MAX_KEEP_DAYS -delete
  done
}

doExit() {
  rm -f "$BUILD_LOCK"
  exit 0
}

###############################################################################

main "$0"
